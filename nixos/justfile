set positional-arguments := true

# ==================================================
# NixOS System Toolkit
# ==================================================

default:
    @printf "\n"
    @printf "NixOS System Toolkit\n"
    @printf "════════════════════════════\n\n"

    @printf "CONVENIENCE\n"
    @printf "  edit                    Edit configuration.nix\n\n"

    @printf "SYSTEM\n"
    @printf "  upgrade                 Update channels + upgrade\n"
    @printf "  rebuild                 sudo nixos-rebuild switch\n"
    @printf "  rebuild-trace           Rebuild with --show-trace\n"
    @printf "  rebuild-verbose         Rebuild with --verbose\n"
    @printf "  rebuild-debug           Rebuild with --debug\n"
    @printf "  rebuild-full            Rebuild with ALL debug flags\n"
    @printf "  build                   Build only\n"
    @printf "  dry-run                 Dry-run configuration check\n"
    @printf "  test                    Test until reboot\n"
    @printf "  rebuild-keep-going      Rebuild with --keep-going\n\n"

    @printf "ROLLBACK & RECOVERY\n"
    @printf "  rollback                Roll back one generation\n"
    @printf "  rollback-to <gen>       Roll back to specific generation\n"
    @printf "  generations             List system generations\n\n"

    @printf "PACKAGES\n"
    @printf "  search <pkg>            Search nixpkgs\n"
    @printf "  install <pkg>           Install package\n"
    @printf "  remove <pkg>            Remove package\n\n"

    @printf "INFO & DIAGNOSTICS\n"
    @printf "  info                    System + nix info\n"
    @printf "  version                 Show NixOS version\n"
    @printf "  logs                    View journal logs\n\n"

    @printf "CLEANUP\n"
    @printf "  gc                      Garbage collect\n"
    @printf "  gc-old                  Delete old generations\n"
    @printf "  clean-user              Clean user generations\n"
    @printf "  clean-system            Clean system generations\n"
    @printf "  optimize                Optimize store\n"
    @printf "  verify-store            Deep store verification\n"
    @printf "  report-disk             Disk usage report\n\n"

    @printf "MAINTENANCE\n"
    @printf "  maintenance             Standard maintenance\n"
    @printf "  maintenance-deep        Maintenance + verification\n\n"


# ==================================================
# Convenience
# ==================================================

edit:
    if command -v gnome-text-editor >/dev/null 2>&1; then \
        sudo gnome-text-editor /etc/nixos/configuration.nix; \
    else \
        sudo nano /etc/nixos/configuration.nix; \
    fi

# ==================================================
# System
# ==================================================

upgrade:
    sudo nix-channel --update
    sudo nixos-rebuild switch --upgrade

rebuild:
    sudo nixos-rebuild switch

rebuild-trace:
    sudo nixos-rebuild switch --show-trace

rebuild-verbose:
    sudo nixos-rebuild switch --verbose

rebuild-debug:
    sudo nixos-rebuild switch --debug

rebuild-full:
    sudo nixos-rebuild switch --show-trace --verbose --debug

build:
    sudo nixos-rebuild build

dry-run:
    sudo nixos-rebuild dry-run

test:
    sudo nixos-rebuild test

rebuild-keep-going:
    sudo nixos-rebuild switch --keep-going



# ==================================================
# Rollback & Recovery
# ==================================================

rollback:
    sudo nixos-rebuild switch --rollback

rollback-to gen:
    sudo nix-env --switch-generation {{gen}} --profile /nix/var/nix/profiles/system


generations:
    sudo nix-env --list-generations --profile /nix/var/nix/profiles/system


# ==================================================
# Packages
# ==================================================

search pkg:
    nix search nixpkgs {{pkg}}

install pkg:
    nix profile install nixpkgs#{{pkg}}

remove pkg:
    sudo nix-env -e {{pkg}}


# ==================================================
# Info & Diagnostics
# ==================================================


info:
    nix-shell -p nix-info --run "nix-info -m"

version:
    nixos-version

logs:
    journalctl -xe


# ==================================================
# Cleanup
# ==================================================

gc:
    sudo nix-collect-garbage

gc-old:
    sudo nix-collect-garbage -d

clean-user:
    nix-env --delete-generations old

clean-system:
    sudo nix-env --delete-generations old --profile /nix/var/nix/profiles/system

optimize:
    sudo nix-store --optimise

verify-store:
    sudo nix-store --verify --check-contents

report-disk:
    df -h /


# ==================================================
# Maintenance
# ==================================================

maintenance:
    just gc-old
    just clean-user
    just clean-system
    just optimize

maintenance-deep:
    just maintenance
    just verify-store
