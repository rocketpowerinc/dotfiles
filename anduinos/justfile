set positional-arguments := true
set shell := ["bash", "-eu", "-o", "pipefail", "-c"]
set export := true

#! ==================================================
#! Color System (Reusable & Clean)
#! ==================================================

ESC    := `printf "\033"`
RESET  := ESC + "[0m"
BOLD   := ESC + "[1m"
DIM    := ESC + "[2m"
UNDER  := ESC + "[4m"

RED    := ESC + "[91m"
GREEN  := ESC + "[92m"
YELLOW := ESC + "[93m"
BLUE   := ESC + "[94m"
PINK   := ESC + "[95m"
CYAN   := ESC + "[96m"
WHITE  := ESC + "[97m"

# Semantic Aliases for your UI
ACCENT  := CYAN
HEADER  := BLUE
SECTION := PINK
SUCCESS := GREEN
WARNING := YELLOW
ERROR   := RED
INFO    := BLUE
SUBTLE  := DIM

#! ==================================================
#! AnduinOS System Toolkit
#! ==================================================
default:
    @clear
    @printf "\n"

    @printf "{{ACCENT}}{{BOLD}}"
    @printf "   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\n"
    @printf "  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•\n"
    @printf "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\n"
    @printf "  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘\n"
    @printf "  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘\n"
    @printf "  â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•\n"
    @printf "{{RESET}}\n"

    @printf "{{HEADER}}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{{RESET}}\n"
    @printf "{{BOLD}}             ğŸš€ AnduinOS System Toolkit ğŸš€{{RESET}}\n"
    @printf "{{SUBTLE}}               Powered by RocketPowerInc{{RESET}}\n"
    @printf "{{HEADER}}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ§° CONVENIENCE{{RESET}}\n"
    @printf "  plj                          {{ACCENT}}Pull Latest Justfile{{RESET}}\n"
    @printf "  pljg                         {{ACCENT}}Pull Latest Justfile GUI{{RESET}}\n\n"

    @printf "{{SECTION}}âš™ SYSTEM{{RESET}}\n"
    @printf "  update                       {{SUCCESS}}Full system update (APT + Flatpak){{RESET}}\n"
    @printf "  upgrade                      {{SUCCESS}}Full AnduinOS System Upgrade{{RESET}}\n"
    @printf "  care                         {{WARNING}}Full system maintenance (APT + Flatpak){{RESET}}\n"
    @printf "  factory-reset                {{ERROR}}Auto repair{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ“¦ APT PACKAGES{{RESET}}\n"
    @printf "  search <pkg>                 {{INFO}}Search apt packages{{RESET}}\n"
    @printf "  install <pkg>                {{SUCCESS}}Install apt package{{RESET}}\n"
    @printf "  remove <pkg>                 {{ERROR}}Remove apt package{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ§Š FLATPAK PACKAGES{{RESET}}\n"
    @printf "  flatpak-search <pkg>         {{INFO}}Search flatpaks{{RESET}}\n"
    @printf "  flatpak-list                 {{INFO}}List flatpaks{{RESET}}\n"
    @printf "  flatpak-remotes              {{INFO}}List remotes{{RESET}}\n"
    @printf "  flatpak-remove-remote        {{ERROR}}Remove remote <name>{{RESET}}\n\n"


    @printf "{{SECTION}}ğŸš€ BOOTSTRAP{{RESET}}\n"
    @printf "  bootload-apps                {{ACCENT}}Install all essential apps (APT + Flatpak){{RESET}}\n"
    @printf "  tune-gnome                   {{ACCENT}}Apply GNOME Gsettings tweaks{{RESET}}\n"
    @printf "  tune-nautilus                {{ACCENT}}Reset Nautilus bookmarks{{RESET}}\n"
    @printf "  install-wallpaper-shuffle    {{ACCENT}}Gets Wallpapers and installs script{{RESET}}\n"
    @printf "  start-wallpaper-shuffle      {{SUCCESS}}Shuffle Wallpapers every 10 min{{RESET}}\n"
    @printf "  stop-wallpaper-shuffle       {{ERROR}}Stops Wallpaper Shuffle on Current Wallpaper{{RESET}}\n"
    @printf "  status-wallpaper-shuffle     {{ERROR}}Is Wallpaper Shuffle Running?{{RESET}}\n\n"


    @printf "{{SECTION}}ğŸ“Š SYSTEM INFO{{RESET}}\n"
    @printf "  report-disk                  {{WARNING}}Disk usage{{RESET}}\n"
    @printf "  report-memory                {{WARNING}}Memory usage{{RESET}}\n"
    @printf "  report-cpu                   {{WARNING}}CPU info{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸŒ EXTERNAL TOOLS{{RESET}}\n"
    @printf "  tuxmate                      {{INFO}}Open TuxMate Website{{RESET}}\n"
    @printf "  linux-toys                   {{INFO}}Linux Toys installer{{RESET}}\n"
    @printf "  linutil                      {{INFO}}Chris Titus LinUtil{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ”— ROCKETPOWERINC{{RESET}}\n"
    @printf "  rocket-dashboard             {{INFO}}Rocket dashboard{{RESET}}\n"
    @printf "  clone-rocketpowerinc         {{INFO}}Clone all public repos{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ“ DESKFLOW & CLIPCASCADE{{RESET}}\n"
    @printf "  install-df                   {{SUCCESS}}Install Deskflow{{RESET}}\n"
    @printf "  install-cc                   {{SUCCESS}}Install ClipCascade{{RESET}}\n"
    @printf "  restart-cc                   {{WARNING}}Restart ClipCascade service{{RESET}}\n"
    @printf "  status-cc                    {{INFO}}Check ClipCascade status{{RESET}}\n\n"

    @printf "{{SECTION}}ğŸ”¨ TOOLS{{RESET}}\n"
    @printf "  change-hostname              {{ERROR}}Change the Machine's Hostname{{RESET}}\n\n"

#! ==================================================
#! Convenience
#! ==================================================

# Pull Latest Justfile
plj:
    TMPDIR=$(mktemp -d) && \
    git clone --depth 1 https://github.com/rocketpowerinc/dotfiles.git "$TMPDIR" && \
    install -m 777 "$TMPDIR/anduinos/justfile" "$HOME/justfile" && \
    rm -rf "$TMPDIR"
    just
# Pull Latest Justfile GUI
pljg:
    TMPDIR=$(mktemp -d) && \
    git clone --depth 1 https://github.com/rocketpowerinc/dotfiles.git "$TMPDIR" && \
    install -m 777 "$TMPDIR/anduinos/justfile-gui.sh" "$HOME/justfile-gui.sh" && \
    rm -rf "$TMPDIR"



#! ==================================================
#! System
#! ==================================================

update:
    sudo apt update && sudo apt upgrade -y
    flatpak update -y
    @echo "System Updated"

upgrade:
    do_anduinos_upgrade

care:
    @printf "\033[1;96mğŸ›  Running Full System Care...\033[0m\n\n"

    @printf "\033[93mğŸ“¦ APT Maintenance...\033[0m\n"
    sudo apt update
    sudo apt upgrade -y
    sudo apt autoremove -y
    sudo apt autoclean
    @printf "\033[92mâœ” APT Complete.\033[0m\n\n"

    @printf "\033[96mğŸ§Š Flatpak Maintenance...\033[0m\n"
    flatpak update -y
    flatpak uninstall --unused -y
    flatpak repair || true
    @printf "\033[92mâœ” Flatpak Complete.\033[0m\n\n"

    @printf "\033[1;95mâœ¨ System Care Finished Successfully!\033[0m\n"

factory-reset:
    do-anduinos-autorepair
    @echo "Factory Reset / Repair Complete"


#! ==================================================
#! Packages (APT)
#! ==================================================

apt-search pkg:
    apt-cache policy {{pkg}}

apt-install pkg:
    sudo apt install -y {{pkg}}

apt-remove pkg:
    sudo apt remove -y {{pkg}}

#! ==================================================
#! Packages (Flatpak)
#! ==================================================

flatpak-search pkg:
    flatpak search {{pkg}}

flatpak-list:
    flatpak list

flatpak-remotes:
    @printf "\033[96mğŸŒ Listing Flatpak remotes...\033[0m\n"
    flatpak remotes
    @printf "\n\033[92mâœ” Done.\033[0m\n"

flatpak-remove-remote remote:
    @printf "\033[91mğŸ—‘ Removing Flatpak remote: {{remote}}...\033[0m\n"
    flatpak remote-delete {{remote}}
    @printf "\033[92mâœ” Remote removed successfully.\033[0m\n"

#! ==================================================
#! Bootstrap
#! ==================================================
bootload-apps:
    @printf "\033[1;96mğŸš€ Cool Bootload Apps - Installing Essentials...\033[0m\n\n"

    # --------------------------------------------------
    # APT CLI Tools
    # --------------------------------------------------
    @printf "\033[93mğŸ“¦ Installing Essential APT CLI Tools...\033[0m\n"
    sudo apt update
    sudo apt install -y \
        fastfetch \
        gh \
        git \
        jq \
        nala \
        yad \
        zenity \
        whiptail \
        just \
        xclip \
        wl-clipboard
    @printf "\033[92mâœ” APT tools installed.\033[0m\n\n"

    # --------------------------------------------------
    # Flatpak Setup
    # --------------------------------------------------
    @printf "\033[96mğŸ§Š Ensuring Flathub remote exists...\033[0m\n"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    # --------------------------------------------------
    # Essential Flatpaks
    # --------------------------------------------------
    @printf "\033[93mğŸ“¦ Installing Essential Flatpaks...\033[0m\n"
    flatpak install -y flathub \
        com.raggesilver.BlackBox \
        com.github.tchx84.Flatseal \
        com.mattjakeman.ExtensionManager \
        org.deskflow.deskflow \
        io.github.flattool.Warehouse \
        com.google.AndroidStudio \
        org.localsend.localsend_app \
        net.nokyan.Resources \
        io.github.shiftey.Desktop \
        org.videolan.VLC \
        org.mozilla.Thunderbird \
        com.visualstudio.code \
        com.valvesoftware.Steam \
        com.todoist.Todoist \
        org.standardnotes.standardnotes \
        md.obsidian.Obsidian \
        io.ente.auth \
        com.bitwarden.desktop \
        com.protonvpn.www \
        me.proton.Mail \
        io.github.brunofin.Cohesion \
        chat.simplex.simplex \
        io.unobserved.espansoGUI \
        org.virt_manager.virt-viewer \
        org.flameshot.Flameshot \
        org.cryptomator.Cryptomator \
        io.github.flattool.Ignition \
        io.github.giantpinkrobots.flatsweep

    @printf "\n\033[92mâœ¨ Cool Bootload Complete! System Fully Loaded.\033[0m\n"

tune-gnome:
    @printf "\033[1;96mğŸ› Applying GNOME Desktop Tweaks...\033[0m\n\n"

    @printf "\033[93mğŸŒ™ Enabling Night Light...\033[0m\n"
    gsettings set org.gnome.settings-daemon.plugins.color night-light-enabled true
    gsettings set org.gnome.settings-daemon.plugins.color night-light-schedule-automatic true

    @printf "\033[93mğŸ–¥ Setting Blank Screen Delay (25 minutes)...\033[0m\n"
    gsettings set org.gnome.desktop.session idle-delay 1500

    @printf "\033[93mğŸ”’ Disabling Lock Screen...\033[0m\n"
    gsettings set org.gnome.desktop.screensaver lock-enabled false

    @printf "\033[93mğŸ”• Disabling Lock Screen Notifications...\033[0m\n"
    gsettings set org.gnome.desktop.notifications show-in-lock-screen false

    @printf "\n\033[92mâœ” GNOME Gsettings Tweaks Applied Successfully!\033[0m\n"

# Reset GTK (Nautilus) bookmarks
tune-nautilus:
    @printf "{{INFO}}ğŸ“š Replacing GTK Bookmarks...{{RESET}}\n"
    @mkdir -p "$HOME/.config/gtk-3.0"
    @printf "%s\n" \
        "file://$HOME/.config/autostart Auto Start" \
        "file://$HOME/.local/share/applications App Drawer" \
        "file://$HOME/.config/gtk-3.0/bookmarks Nautilus Bookmarks" \
        "file://$HOME/.config/systemd/user Systemctl Services" \
        > "$HOME/.config/gtk-3.0/bookmarks"
    @printf "{{SUCCESS}}âœ” GTK bookmarks updated successfully.{{RESET}}\n"


# ==================================================
# Wallpaper Slideshow
# ==================================================

install-wallpaper-shuffle:
	TMPDIR=$(mktemp -d) && \
	git clone --depth 1 https://github.com/rocketpowerinc/scriptbin.git "$TMPDIR" && \
	install -Dm755 "$TMPDIR/bash/linux/wallpaper-shuffle.sh" "$HOME/.local/bin/wallpaper-shuffle" && \
	rm -rf "$TMPDIR" && \
	mkdir -p "$HOME/.config/systemd/user" && \
	cat > "$HOME/.config/systemd/user/wallpaper-shuffle.service" << 'EOF'
	[Unit]
	Description=Wallpaper Shuffle Slideshow
	After=graphical-session.target
	Wants=graphical-session.target

	[Service]
	Type=simple
	ExecStart=%h/.local/bin/wallpaper-shuffle
	Restart=on-failure
	RestartSec=5

	[Install]
	WantedBy=graphical-session.target
	EOF
	systemctl --user daemon-reload && \
	echo "âœ… Installed systemd user service"


start-wallpaper-shuffle:
    systemctl --user enable wallpaper-shuffle && systemctl --user start wallpaper-shuffle

stop-wallpaper-shuffle:
    systemctl --user disable wallpaper-shuffle && systemctl --user stop wallpaper-shuffle

status-wallpaper-shuffle:
    systemctl --user status wallpaper-shuffle



#! ==================================================
#! SYSTEM INFO
#! ==================================================

report-disk:
    df -h /

report-memory:
    free -h

report-cpu:
    lscpu


#! ==================================================
#! External Tools
#! ==================================================

tuxmate:
    xdg-open "https://tuxmate.com/" >/dev/null 2>&1 &

linux-toys:
    x-terminal-emulator -e bash -c 'curl -fsSL https://linux.toys/install.sh | bash'

linutil:
    x-terminal-emulator -e bash -c 'curl -fsSL https://christitus.com/linux | sh'


#! ==================================================
#! RocketPowerInc
#! ==================================================

rocket-dashboard:
    xdg-open https://rocketdashboard.notion.site/Welcome-to-RocketPowerInc-1a1627bc6fd8805ab693f164a1b3ceda >/dev/null 2>&1 &


#todo Keep it so it does not overwrite repos if they exist
clone-rocketpowerinc:
	TARGET_DIR="$HOME/Github/rocketpowerinc"; \
	printf "ğŸ“¦ Fetching public repositories for rocketpowerinc...\n"; \
	mkdir -p "$TARGET_DIR"; \
	curl -s "https://api.github.com/users/rocketpowerinc/repos?per_page=100" \
	| jq -r '.[] | "\(.name) \(.clone_url)"' \
	| while read -r repo_name clone_url; do \
		repo_path="$TARGET_DIR/$repo_name"; \
		if [ ! -d "$repo_path/.git" ]; then \
			echo "Cloning $repo_name..."; \
			git clone "$clone_url" "$repo_path"; \
		else \
			echo "$repo_name already exists. Skipping..."; \
		fi; \
	done; \
	printf "âœ… All public repositories cloned to: %s\n" "$TARGET_DIR"


#! ==================================================
#! Deskflow and ClipCascade
#! ==================================================

install-df:
    @printf "\033[96mğŸ§Š Installing Deskflow (Flatpak)...\033[0m\n"
    flatpak install -y flathub org.deskflow.deskflow

    @printf "\033[93mâš™ Installing GNOME Tweaks for Start at boot option...\033[0m\n"
    sudo apt update
    sudo apt install -y gnome-tweaks

    @printf "\033[92mâœ” Deskflow and GNOME Tweaks installed successfully.\033[0m\n"

install-cc:
    TMPDIR=$(mktemp -d) && \
    git clone --depth 1 https://github.com/rocketpowerinc/scriptbin.git "$TMPDIR" && \
    chmod +x "$TMPDIR/bash/linux/clipcascade-install-ubuntu.sh" && \
    bash "$TMPDIR/bash/linux/clipcascade-install-ubuntu.sh" && \
    rm -rf "$TMPDIR"

restart-cc:
    @printf "\033[93mğŸ”„ Restarting ClipCascade...\033[0m\n"
    systemctl --user restart clipcascade
    @printf "\033[92mâœ” ClipCascade restarted.\033[0m\n"
    sleep 4s
    systemctl --user status clipcascade

status-cc:
    systemctl --user status clipcascade


#! ==================================================
#! Tools
#! ==================================================



# Change the system hostname and update /etc/hosts
change-hostname:
    #!/usr/bin/env bash
    set -e
    current=$(hostname)

    echo -e "\nğŸ–¥ Current hostname: $current\n"

    read -p "Enter new hostname: " host_input

    if [ -z "$host_input" ]; then
        echo "Aborted."
        exit 1
    fi

    read -p "Change hostname to '$host_input'? (y/N): " confirm

    case "$confirm" in
        [yY]*) ;;
        *) echo "Cancelled."; exit 1 ;;
    esac

    # 1. Change the system hostname
    sudo hostnamectl set-hostname "$host_input"

    # 2. Update the hosts file to prevent sudo lag/resolution errors
    sudo sed -i "s/$current/$host_input/g" /etc/hosts

    echo "âœ” Hostname changed and /etc/hosts updated."

    # 3. Recommendation to restart
    echo -e "\nâš ï¸  A reboot is recommended to ensure all services use the new hostname."
    read -p "Restart system now? (y/N): " reboot_confirm

    if [[ "$reboot_confirm" =~ ^[yY] ]]; then
        sudo reboot
    else
        echo "Done. Please remember to restart later for changes to fully take effect."
    fi
